# https://kamailio.org/docs/tutorials/6.0.x/kamailio-install-guide-git/#prerequisites
# Installing---------------------------------------

# Sources https://www.kamailio.org/pub/kamailio/
wget https://github.com/kamailio/kamailio/archive/refs/tags/6.0.1.tar.gz
tar -x -zf 6.0.1.tar.gz

apt-get install gcc g++ flex bison libmysqlclient-dev -y
apt-get install mysql-server -y

cd kamailio-6.0.1/
make cfg

# make include_modules="db_mysql dialplan tls" cfg
vi src/modules.lst
#  include_modules= db_mysql dialplan tls countersacc cfg_rpc ctl sanity xlog siputils textopsx textops registrar usrloc maxfwd pv rr sl tmx tm corex kex jsonrpcs

make all
make install
make install-systemd-debian

# If you need just modules: 
cat <<EOF > kamdb_mysql.sh # heredoc
#!/bin/bash
apt install kamailio -y
apt-get install libmysqlclient-dev -y
# kamctl srv version
wget https://www.kamailio.org/pub/kamailio/5.7.4/src/kamailio-5.7.4_src.tar.gz && tar -x -zf kamailio-5.7.4_src.tar.gz && cd kamailio-5.7.4
make include_modules="db_mysql" cfg
sed -i '/^modules_all=/ s/^/#/' src/modules.lst
comment # modules_all=
make modules
cp src/modules/db_mysql/db_mysql.so /usr/lib/x86_64-linux-gnu/kamailio/modules/
cp utils/kamctl/kamdbctl.mysql /usr/lib/x86_64-linux-gnu/kamailio/kamctl/
sed -i '/^#!define WITH_MYSQL$/d' /etc/kamailio/kamailio.cfg
sed -i '1i\#!define WITH_MYSQL' /etc/kamailio/kamailio.cfg
kamctl restart && kamctl srv modules
EOF

# Configuring---------------------------------------
# --- Database
# https://dev.mysql.com/doc/mysql-getting-started/en/

apt-get install mysql-server -y
mysql_secure_installation
mysql -u root -p
# ALTER USER 'root'@'localhost' IDENTIFIED BY 'new_password';

vi /usr/local/etc/kamailio/kamctlrc # or vi /etc/kamailio/kamctlrc
# SIP_DOMAIN=mysipserver.com
# DBENGINE=MYSQL
# DBHOST=localhost
# DBRWUSER="kamailio"
# DBRWPW="kamailiorw"
/usr/local/sbin/kamdbctl create

# --- Kamailio
vi /usr/local/etc/kamailio/kamailio.cfg
# SIP_DOMAIN=mysipserver.com
vi /usr/local/etc/kamailio/kamailio-local.cfg
# #!define WITH_MYSQL
# #!define WITH_AUTH



